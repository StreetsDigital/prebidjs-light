# pbjs_engine

A lightweight Prebid.js wrapper platform that enables publishers to run header bidding with server-managed configurations.

## Overview

pbjs_engine provides:

- **Minified JS Wrapper**: Publishers receive a minified JS file with a unique identifier that fetches their config from your server
- **Admin Dashboard**: Full admin dashboard for managing publisher configs
- **Publisher Portal**: Self-service publisher portal for configuration management
- **Dynamic Bundling**: Dynamic Prebid module bundling based on publisher needs
- **Analytics Pipeline**: Real-time analytics capable of handling 1B+ impressions

The wrapper exposes a clean `pb` namespace for publishers while providing access to the underlying `pbjs` object for advanced users.

## Technology Stack

### Frontend
- React 18 with Vite
- Tailwind CSS
- Zustand (state management)
- Recharts (analytics dashboards)
- React Hook Form with Zod validation
- Headless UI components

### Backend
- Node.js 20 LTS
- Fastify framework
- PostgreSQL 15 (config, users, publishers)
- ClickHouse (event storage, analytics at scale)
- Redis (caching, sessions, rate limiting, message queue)
- Drizzle ORM

### Build Service
- Webpack 5 for dynamic Prebid.js compilation
- Per-publisher optimized builds

## Prerequisites

- Node.js 20 LTS or higher
- Docker and Docker Compose
- Git

## Quick Start

1. Clone the repository:
   ```bash
   git clone <repository-url>
   cd pbjs_engine
   ```

2. Run the setup script:
   ```bash
   ./init.sh
   ```

3. Run database migrations:
   ```bash
   npm run db:migrate
   ```

4. Seed the database:
   ```bash
   npm run db:seed
   ```

5. Start development servers:
   ```bash
   npm run dev
   ```

## Project Structure

```
pbjs_engine/
├── apps/
│   ├── admin/          # React admin dashboard
│   ├── api/            # Fastify API server
│   └── wrapper/        # Publisher JS wrapper
├── packages/
│   └── shared/         # Shared types and utilities
├── docker/             # Docker configuration files
├── scripts/            # Build and deployment scripts
├── docker-compose.yml  # Docker Compose configuration
└── init.sh             # Development setup script
```

## Available Scripts

| Command | Description |
|---------|-------------|
| `npm run dev` | Start all development servers |
| `npm run dev:api` | Start API server only |
| `npm run dev:admin` | Start Admin UI only |
| `npm run build` | Build all packages for production |
| `npm run docker:up` | Start Docker services |
| `npm run docker:down` | Stop Docker services |
| `npm run docker:logs` | View Docker service logs |
| `npm run db:migrate` | Run database migrations |
| `npm run db:seed` | Seed the database |
| `npm run test` | Run all tests |
| `npm run lint` | Run linting |

## Services

When running in development mode:

| Service | URL |
|---------|-----|
| Admin Dashboard | http://localhost:3000 |
| API Server | http://localhost:3001 |
| PostgreSQL | localhost:5432 |
| Redis | localhost:6379 |
| ClickHouse | localhost:8123 |

## User Roles

- **Super Admin**: Full platform access - manage all publishers, users, system settings
- **Admin**: Staff access - manage assigned publishers only
- **Publisher**: Self-service access - manage own configuration and view analytics

## pb Namespace API

Publishers interact with the wrapper through the `pb` namespace:

```javascript
// Initialize and run auction
pb.init();

// Refresh specific ad slots
pb.refresh(['ad-unit-1', 'ad-unit-2']);

// Get current configuration
const config = pb.getConfig();

// Update configuration
pb.setConfig({ bidderTimeout: 2000 });

// Event listeners
pb.on('auctionEnd', (data) => console.log(data));

// Access underlying Prebid.js instance
const pbjs = pb.pbjs;

// Get version and publisher ID
console.log(pb.version, pb.publisherId);
```

## Environment Variables

Create a `.env` file (or use the one generated by `init.sh`):

```env
# Database
DATABASE_URL=postgresql://pbjs:pbjs_dev_password@localhost:5432/pbjs_engine
REDIS_URL=redis://localhost:6379
CLICKHOUSE_URL=http://localhost:8123

# Authentication
JWT_SECRET=your-secure-secret
JWT_EXPIRY=24h
REFRESH_TOKEN_EXPIRY=7d

# API
API_PORT=3001
API_HOST=0.0.0.0

# Frontend
VITE_API_URL=http://localhost:3001

# Build Service
BUILD_OUTPUT_DIR=./builds
PREBID_VERSION=latest
```

## Testing

The project includes comprehensive test suites:

```bash
# Run all tests
npm run test

# Run specific package tests
npm -w apps/api run test
npm -w apps/admin run test
```

## License

Proprietary - All rights reserved
